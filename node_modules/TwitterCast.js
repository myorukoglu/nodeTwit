var http 	= require("http"),
	events 	= require("events");
//Emiter and misc status object
exports.TwitterCaster = {
	Broadcaster : new events.EventEmitter(),  
	last		: 0,
	requests	: 0  		
}


//Search Twitter for something
exports.SearchTwitter = function(searchTerm, eventDriver){
	//open the stream from twitter
	var request = http.request({
		host 	: "search.twitter.com",
		port 	: 80,
		method 	: "GET",
		path 	: '/search.json?since_id='+ eventDriver.last + 'lang=en&result_type=recent&rpp=7&q=' + searchTerm
	}).on("response", function(response){
		var body = "";
		response.on("data", function(data){
			body += data;
			//yuck,yuck,yuck hated this part but there is no on "end" with a stream which is what this is so
			//you've got to keep chunking until you get well formed JSON.  Fought with the commented code below for a while but no luck
			//twitter puts a \r at the end of a json response to let you know when it was done, but I couldn't get that work for ... yet
			try {
				var tweets = JSON.parse(body);

				if (tweets.results.length > 0) {
					eventDriver.Broadcaster.emit("tweeted", tweets, searchTerm);
				}
				else{
					console.log("nothing new for " + searchTerm);
					//found nothing so all done remove the request from the counter
					eventDriver.requests--;
					//fire the event 
					eventDriver.Broadcaster.emit("requestComplete", eventDriver.requests);
				}
			} 
			catch (ex) {
			}
		});
	});

	//End the request to flush the stream
	request.end();	
	

	// var request = http.request({
	// 	host 	: "search.twitter.com",
	// 	port 	: 80,
	// 	method 	: "GET",
	// 	path 	: '/search.json?q=' + searchTerm
	// }).on("response", function(response){
	// 	var content = "";

	// 	response.on("data", function(data){
	// 		content += data;
	// 		//console.log(data)
	// 		var index = content.indexOf('\r');
	// 		if(index !== -1){
	// 			//grab the content up to the index
	// 			var tweeted = content.slice(0, index);
	// 			//broadcast the events
	// 			broadcaster.emit("tweeted", JSON.parse(tweeted));
	// 			//reset the content
	// 			content = content.slice(newlineIndex + 1);
				
	// 		}
			
	// 	});
	// });
	// request.end();

}